<html>
<head>
	<link rel="stylesheet" type="text/css" href="/lib/bootstrap-4.6.0-dist/css/bootstrap.min.css">

	<link rel="stylesheet" type="text/css" href="/lib/fontawesome-free-5.10.1-web/css/fontawesome.min.css">
	<link rel="stylesheet" type="text/css" href="/lib/fontawesome-free-5.10.1-web/css/brands.min.css">
	<link rel="stylesheet" type="text/css" href="/lib/fontawesome-free-5.10.1-web/css/solid.min.css">

	<script type="text/javascript" src="/lib/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="/lib/bootstrap-4.6.0-dist/js/bootstrap.min.js"></script>
</head>


<body>
	Auto




	
	<button type="button" class="btn btn-primary" id="id_btn_fetch">Fetch</button>


	<!-- <textarea id="id_txt_fetched_content"></textarea> -->


	<!-- <button type="button" class="btn btn-primary" id="id_btn_parse">Parse</button> -->

</body>




</html>
<script>
var _music_list = [];
var _content;

$('document').ready(function(){
	$('#id_btn_fetch').on('click', FetchContent);
	$('#id_btn_parse').on('click', ParseContent);
});

var url_global = 'https://music.apple.com/us/playlist/top-100-global/pl.d25f5d1181894928af76c85c967f8f31';
var url_korea = 'https://music.apple.com/kr/playlist/%EC%98%A4%EB%8A%98%EC%9D%98-top-100-%EB%8C%80%ED%95%9C%EB%AF%BC%EA%B5%AD/pl.d3d10c32fbc540b38e266367dc8cb00c';

function FetchContent(){
	var req_data = {
		url: url_korea
	};

	$.ajax({
			url: '/__cms_api/fetch_content',
			type: 'POST',
			data: JSON.stringify(req_data),
			contentType: 'application/json; charset=utf-8',
			dataType: 'json',
			success: function (res) {
				if(res.ok){
					console.log('success ');
					// $('#id_txt_fetched_content').val(res.content);
					// self._music_list = res.music_list;
					// self.DisplayMusicList();
					_content = res.content;
					ParseContent();
				}else{
					alert(res.err);
				}
			}
		});	
}

function ParseContent(){
	var arr = _content.split('\n');
	// console.log('arr len ' + arr.length);
	for(var i=0 ; i<arr.length ; i++){
		var line = arr[i];

		//노래를 찾았음.
		if(line.includes('song-name typography-body-tall')){
			var music = {
				title:'',
				artist:[],
				video_id:''
			};

			//바로 그 다음 줄에 제목이 있음.
			var title_str = arr[i+1];
			music.title = ParseTitle(title_str);

			var artist_str = arr[i+3];
			music.artist = ParseArtist(artist_str);

			_music_list.push(music);
		}
	}

	console.log('len ' + _music_list.length);
	
	for(var i=0 ; i<_music_list.length ; i++){
		var m = _music_list[i];
		console.log(i + ' ' + m.title);
		for(var a=0 ; a<m.artist.length ; a++){
			console.log('\t ' + m.artist[a]);
		}
	}
}

/**
	Example 
 	<!---->Leave The Door Open</div>
*/
function ParseTitle(str){
	str = str.substr('<!---->'.length);
	return str.substr(0, str.length - (str.length - str.lastIndexOf('</div>')));
}

/**
	Example
                                        <span>                                                    <a href="https://music.apple.com/us/artist/bruno-mars/278873078" class="dt-link-to" tabindex="-1">Bruno Mars</a>,                                                    <a href="https://music.apple.com/us/artist/anderson-paak/855484536" class="dt-link-to" tabindex="-1">Anderson .Paak</a>,                                                    <a href="https://music.apple.com/us/artist/silk-sonic/1556097160" class="dt-link-to" tabindex="-1">Silk Sonic</a><!----></span>
*/
function ParseArtist(str){
	var artist_list = [];
	var arr = str.split('</a>');
	for(var i=0 ; i<arr.length ; i++){
		var tmp = arr[i];
		var index_of = tmp.indexOf('class="dt-link-to" tabindex="-1">');
		if(index_of != -1){
			var begin_pos = index_of + 'class="dt-link-to" tabindex="-1">'.length;
			var artist = tmp.substr(begin_pos);
			artist_list.push(artist);
		}
	}
	return artist_list;
}
</script>
